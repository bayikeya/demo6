<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>複数画像切替付きスポット案内（自動音声版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: sans-serif; text-align: center; }
    #camera { width: 100vw; height: 100vh; object-fit: cover; position: absolute; top: 0; left: 0; z-index: -1; }
    #info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; z-index: 1; white-space: pre-wrap; }
    #image { position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%); width: 300px; height: 300px; object-fit: contain; display: none; z-index: 1; background: black; }
    .btn { position: absolute; left: 50%; transform: translateX(-50%); background-color: #007BFF; color: white; border: none; padding: 10px 20px; font-size: 14px; border-radius: 8px; cursor: pointer; z-index: 2; display: none; }
    #patternBtn { bottom: 70px; }
    #nextBtn { bottom: 20px; }
    .img-nav { position: absolute; bottom: 260px; z-index: 2; font-size: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 5px 15px; cursor: pointer; border-radius: 6px; }
    #prevBtn { left: 10%; }
    #nextImgBtn { right: 10%; }
  </style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<div id="info">位置情報取得中...</div>
<img id="image" src="" alt="スポット画像" />
<button class="btn" id="patternBtn" onclick="switchPattern()">English</button>
<button class="btn" id="nextBtn" onclick="goToNextSpot()">このスポットは完了</button>
<button class="img-nav" id="prevBtn" onclick="showPrevImage()" style="display:none;">←</button>
<button class="img-nav" id="nextImgBtn" onclick="showNextImage()" style="display:none;">→</button>
<audio id="audio" src=""></audio>

<script>
/*
  統合版スクリプト:
  - 既存のスポット配列(defaultSpots)を保持
  - GeoJSON(route.geojson)が存在すればそれを読み込み route 配列に変換して利用
  - カルマンフィルタでGPSを平滑化
  - 画像切替、音声切替、次スポット遷移など既存機能を保持
*/

/* ---------------- DOM ---------------- */
const camera = document.getElementById("camera");
const info = document.getElementById("info");
const image = document.getElementById("image");
const nextBtn = document.getElementById("nextBtn");
const patternBtn = document.getElementById("patternBtn");
const audio = document.getElementById("audio");
const prevBtn = document.getElementById("prevBtn");
const nextImgBtn = document.getElementById("nextImgBtn");

/* ---------------- 既定のスポット（フォールバック） ---------------- */
const defaultSpots = [
  { name: "13号館前", lat: 35.69302425885399, lon: 140.0508424409975, radius: 0, images: ["image0.jpeg", "image1.jpeg"], audio: { A: "spot1.ja.mp3", B: "spot1.en.mp3", C: "spot1.ch.mp3" } },
  { name: "曲がり角右", lat:35.69283599175495,  lon:140.05092001888113, radius: 10, images: ["image3.jpeg", "image11.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } },
  { name: "曲がり角右１", lat: 35.69286877921128,   lon: 140.05030279528978, radius: 10, images: ["image4.jpeg", "image13.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } },
  { name: "曲がり角右２", lat: 35.69334894066289,  lon: 140.05033682451656, radius: 10, images: ["image5.jpeg", "image14.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } },
  { name: "曲がり角右３", lat: 35.69331981781718,  lon: 140.05102244720183, radius: 10, images: ["image6.jpeg", "image15.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } },
  { name: "目的地", lat: 35.693014464267506,  lon: 140.0509410980045, radius: 10, images: ["image7.jpeg", "image16.jpeg"], audio: { A: "spot7,8.ja.mp3", B: "spot7,8.en.mp3", C: "spot7,8.ch.mp3" } }
];

/* ---------------- ルート（GeoJSON などで上書き可能） ---------------- */
let route = [];        // 実際に使用するスポット配列
let currentIndex = 0;  // 現在のスポットインデックス
let hasEnteredSpot = false;
let currentSpot = null;
let currentPattern = "A";
let imageIndex = 0;

/* ---------------- カメラ起動 ---------------- */
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
  .then(stream => camera.srcObject = stream)
  .catch(err => console.log("カメラへのアクセスに失敗しました: ", err));

/* ---------------- 距離計算（haversine） ---------------- */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ---------------- カルマンフィルタ（簡易・分離） ---------------- */
let lastLat = null, lastLon = null;
let xLat = 0, xLon = 0;
let P_lat = 1, P_lon = 1;
const Q = 0.00001; // プロセスノイズ（小さめ）
const R_var = 5;   // 観測ノイズ（大きめ）

function kalman(lat, lon) {
  if (lastLat === null || lastLon === null) {
    lastLat = lat; lastLon = lon;
    xLat = lat; xLon = lon;
    return { lat, lon };
  }

  // lat
  P_lat = P_lat + Q;
  let K_lat = P_lat / (P_lat + R_var);
  xLat = xLat + K_lat * (lat - xLat);
  P_lat = (1 - K_lat) * P_lat;

  // lon
  P_lon = P_lon + Q;
  let K_lon = P_lon / (P_lon + R_var);
  xLon = xLon + K_lon * (lon - xLon);
  P_lon = (1 - K_lon) * P_lon;

  lastLat = xLat; lastLon = xLon;
  return { lat: xLat, lon: xLon };
}

/* ---------------- スポット判定 ---------------- */
function checkProximity(lat, lon) {
  if (currentIndex >= route.length) {
    info.innerText = "すべてのスポットを通過しました。";
    hideAllUI();
    return;
  }
  const spot = route[currentIndex];
  const distance = getDistance(lat, lon, spot.lat, spot.lon);
  const range = spot.radius || 10;

  info.innerText =
    `現在地: 緯度 ${lat.toFixed(6)}, 経度 ${lon.toFixed(6)}\n` +
    `次のスポット: ${spot.name}（${currentIndex + 1} / ${route.length}）\n` +
    `残り距離: ${distance.toFixed(1)}m`;

  if (!hasEnteredSpot && distance < range) {
    showSpot(spot);
  }
}

/* ---------------- スポット表示 ---------------- */
function showSpot(spot) {
  currentSpot = spot;
  hasEnteredSpot = true;
  imageIndex = 0;

  audio.src = (spot.audio && spot.audio[currentPattern]) ? spot.audio[currentPattern] : "";
  image.src = (spot.images && spot.images.length) ? spot.images[imageIndex] : "";
  image.style.display = (spot.images && spot.images.length) ? "block" : "none";
  nextBtn.style.display = "block";
  patternBtn.style.display = "block";
  prevBtn.style.display = (spot.images && spot.images.length > 1) ? "block" : "none";
  nextImgBtn.style.display = (spot.images && spot.images.length > 1) ? "block" : "none";

  audio.loop = true;
  audio.play().catch(e => console.log("自動再生に失敗:", e));
}

/* ---------------- 画像切替 ---------------- */
function showPrevImage() {
  if (!currentSpot || !currentSpot.images) return;
  imageIndex = (imageIndex - 1 + currentSpot.images.length) % currentSpot.images.length;
  image.src = currentSpot.images[imageIndex];
}
function showNextImage() {
  if (!currentSpot || !currentSpot.images) return;
  imageIndex = (imageIndex + 1) % currentSpot.images.length;
  image.src = currentSpot.images[imageIndex];
}

/* ---------------- 音声パターン切替 ---------------- */
function switchPattern() {
  const patterns = ["A", "B", "C"];
  const index = patterns.indexOf(currentPattern);
  currentPattern = patterns[(index + 1) % patterns.length];
  updatePatternButtonText();

  if (currentSpot && currentSpot.audio) {
    audio.pause();
    audio.src = currentSpot.audio[currentPattern];
    audio.play().catch(e => console.log("自動再生に失敗:", e));
  }
}

function updatePatternButtonText() {
  let label = "";
  switch (currentPattern) {
    case "A": label = "English"; break;
    case "B": label = "中文"; break;
    case "C": label = "日本語"; break;
  }
  patternBtn.innerText = label;
}

/* ---------------- 次のスポットへ ---------------- */
function goToNextSpot() {
  audio.pause();
  currentIndex++;
  hasEnteredSpot = false;
  currentSpot = null;
  hideAllUI();
}

/* ---------------- UI 非表示 ---------------- */
function hideAllUI() {
  image.style.display = "none";
  nextBtn.style.display = "none";
  patternBtn.style.display = "none";
  prevBtn.style.display = "none";
  nextImgBtn.style.display = "none";
}

/* ---------------- GPS監視 ---------------- */
function startGeolocationWatch() {
  if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(
      pos => {
        const corrected = kalman(pos.coords.latitude, pos.coords.longitude);
        checkProximity(corrected.lat, corrected.lon);
      },
      err => info.innerText = "位置情報の取得に失敗しました: " + (err && err.message ? err.message : err),
      { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
  } else {
    info.innerText = "このブラウザでは位置情報が利用できません。";
  }
}

/* ---------------- GeoJSON読み込み（任意） ---------------- */
async function loadGeoJSONIfExists() {
  try {
    const res = await fetch("demo.geojson", { cache: "no-store" });
    if (!res.ok) throw new Error("route.geojson not found");
    const data = await res.json();

    // サポート: LineString or Point features
    const features = data.features || [];
    const points = [];

    features.forEach((f, idx) => {
      if (!f.geometry) return;
      const g = f.geometry;
      if (g.type === "LineString") {
        // LineString の各座標をポイントとして扱う
        g.coordinates.forEach((c, i) => {
          points.push({
            lon: c[0],
            lat: c[1],
            name: `点 ${idx + 1}-${i + 1}`,
            radius: 10,
            images: ["image0.jpeg"],
            audio: { A: "spot1.ja.mp3", B: "spot1.en.mp3", C: "spot1.ch.mp3" }
          });
        });
      } else if (g.type === "Point") {
        const c = g.coordinates;
        points.push({
          lon: c[0],
          lat: c[1],
          name: (f.properties && f.properties.name) ? f.properties.name : `点 ${idx + 1}`,
          radius: (f.properties && f.properties.radius) ? f.properties.radius : 10,
          images: (f.properties && f.properties.images) ? f.properties.images : ["image0.jpeg"],
          audio: (f.properties && f.properties.audio) ? f.properties.audio : { A: "spot1.ja.mp3", B: "spot1.en.mp3", C: "spot1.ch.mp3" }
        });
      }
    });

    if (points.length > 0) {
      route = points;
      console.log("GeoJSON route loaded. Points:", route.length);
      return;
    } else {
      throw new Error("route.geojson に有効な座標がありません");
    }
  } catch (e) {
    console.log("GeoJSON 読み込みをスキップ: ", e.message || e);
    // フォールバック
    route = defaultSpots.slice();
  }
}

/* ---------------- 起動 ---------------- */
window.onload = async () => {
  // GeoJSON があれば route を上書き、なければ defaultSpots を使用
  await loadGeoJSONIfExists();

  // route が空ならフォールバック
  if (!route || route.length === 0) route = defaultSpots.slice();

  // 最初のスポットを表示（従来の挙動を保持）
  currentIndex = 0;
  hasEnteredSpot = false;
  currentSpot = null;
  updatePatternButtonText();

  // 必要なら起動時に最初のスポットを見せる（元コードと同様）
  // showSpot(route[0]);

  // GPS監視開始
  startGeolocationWatch();

  // もし起動時に最初のスポットを常に表示したければ上のコメントを外してください
};
</script>

</body>
</html>
